<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Tamilnadu Covid Beds Availability Map">
     <meta name="author" content="Prashanth R">
    <title>TN Covid Beds Map</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    />
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.gstatic.com">
	<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap" rel="stylesheet"> 
    <style>
      #map {
        height: 100%;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: 'Roboto', sans-serif;
      }
      #poweredby{
      	position: fixed;
		z-index: 999;
		bottom: 3px;
		right: 50px;
		font-size: 12px;
      }
      .green-icon{
      	height: 17px !important;
      	width: 17px !important;
      	border-radius: 50%;
      	background-color: green;
      }
      .red-icon{
      	height: 17px !important;
      	width: 17px !important;
      	border-radius: 50%;
      	background-color: red;
      }
      .hospitalInfo{
      	z-index: 999;
		position: absolute;
		top: 20px;
		height: auto;
		width: 300px;
		right: 20px;
		margin-bottom: 20px;
		max-height: 90%;
      }
      .bedsInfo{
      	width:100%;
      }
      .bedsInfo tr{
      	margin-bottom: 15px;
      }
      .title{
      	position: absolute;
		z-index: 999;
		left: 10px;
		bottom: 10px;
      }
    </style>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script> 
	<script type="text/javascript" type="module">
    	window.filterData = {
    		oxygen_supported: true,
    		non_oxygen_supported: true,
    		icu_beds: true,
    		show_only_vacant: true
    	}
    </script>
  </head>

  <body>
  	<div class="title shadow-md rounded bg-white p-2">TN Covid Beds Availability</div>
    <div id="map"></div>
    <div style="display: none;" class="hospitalInfo">
    	<div class="shadow-md rounded bg-red-500 text-white p-1" style="float: right; width:30px; height: 30px; text-align:center; cursor:pointer" onclick="closeHospital()">
    		<span >X</span>
    	</div>
    	<div class="shadow-md rounded bg-blue-500 text-white p-4 mt-8">
    		<div id="institution" class="text-xl"></div>
	    	<div id="address" class="mt-1"></div>
	    	<div id="landline" class="mt-1">
	    		<a href="" class="underline"></a>
	    	</div>
	    	<div id="contact" class="mt-1">
	    		<a href="" class="underline"></a>
	    	</div>
    	</div>
    	<div class="shadow-md rounded bg-white p-4 mt-2">
    		<table class="bedsInfo">
    			<tbody>
    				<tr>
	    				<td style="width:90%">
	    					Oxygen Supported Beds
	    				</td>
	    				<td id="oxygen_supported" class="font-bold"></td>
	    			</tr>
	    			<tr>
	    				<td style="width:90%">
	    					Normal Beds(wihtout oxygen support)
	    				</td>
	    				<td id="non_oxygen_supported" class="font-bold"></td>
	    			</tr>
	    			<tr>
	    				<td style="width:90%">
	    					ICU Beds
	    				</td>
	    				<td id="icu_beds" class="font-bold"></td>
	    			</tr>
    			</tbody>
    		</table>
    	</div>
    	<div class="shadow-md rounded bg-white p-4 mt-2">
    		<div class="font-bold">Last Updated</div>
    		<div id="lastUpdated"></div>
    	</div>
    </div>
    <div id="poweredby" class="underline text-blue-500">Powered By <a target="_blank" href="https://about.me/prashanthrv">Half Buddha Creations</a></div>
    <script type="text/javascript" type="module">
      window.closeHospital = function(){
      	$('.hospitalInfo').hide();
      }
      var map = L.map("map", {
        center: [11.388, 80.75],
        zoom: 7
      });
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(
        map
      );

      const openHospitalPage = function(hospitalData){
      	$('.hospitalInfo').show();
      	$('#institution').text(hospitalData.Name)
      	const taluk = hospitalData.Taluk!==undefined?hospitalData.Taluk.Name:''
      	const district = hospitalData.District!==undefined?hospitalData.District.Name:''
      	$('#address').text(hospitalData.AddressDetail.Line1+','+taluk+','+district)
      	$('#contact a').text(hospitalData.MobileNumber)
      	$('#contact a').attr('href','tel:'+hospitalData.MobileNumber)
      	$('#landline a').text(hospitalData.Landline)
      	$('#landline a').attr('href','tel:'+hospitalData.Landline)

      	$('#oxygen_supported').text(hospitalData.CovidBedDetails.VaccantO2Beds+"/"+hospitalData.CovidBedDetails.AllotedO2Beds)
      	$('#non_oxygen_supported').text(hospitalData.CovidBedDetails.VaccantNonO2Beds+"/"+hospitalData.CovidBedDetails.AllotedNonO2Beds)
      	$('#icu_beds').text(hospitalData.CovidBedDetails.VaccantICUBeds+"/"+hospitalData.CovidBedDetails.AllotedICUBeds)

      	$('#lastUpdated').text(new Date(hospitalData.UpdatedDateTime*1000))
      	$('#remarks').text(hospitalData.remarks)	
      }

      const params = {"searchString":"","sortCondition":{"Name":1},"pageNumber":1,"pageLimit":2000,"SortValue":"Availability","ShowIfVacantOnly":"","IsGovernmentHospital":true,"IsPrivateHospital":true,"FacilityTypes":["CHO","CHC","CCC"]};

      $.ajax({
      	method:'post',
      	url: 'https://tncovidbeds.tnega.org/api/hospitals',
      	data: JSON.stringify(params),
      	contentType: "application/json",
      	dataType: "json",
      	success: function(data){
      		data.result.forEach((hospital)=>{
      			if(hospital.Latitude!==undefined && hospital.Latitude!==null && hospital.Longitude!==undefined && hospital.Longitude!==null){
      				const greenIcon = L.divIcon({className: 'green-icon'});
	      			const redIcon = L.divIcon({className: 'red-icon'});
	      			let myIcon = null;
	      			if(parseInt(hospital.CovidBedDetails.VaccantO2Beds)>0 || parseInt(hospital.CovidBedDetails.VaccantNonO2Beds)>0 || parseInt(hospital.CovidBedDetails.VaccantICUBeds)>0){
		 		       	myIcon = greenIcon
		        	}else{
		        		myIcon = redIcon
		        	}
	      			const hospitalMarker = L.marker([hospital.Latitude, hospital.Longitude], { icon: myIcon}).addTo(map)
	      			hospitalMarker.on('click', function(data){
			        	openHospitalPage(hospital)
			        })
      			}
      		})
      	}
      });
    </script>
  </body>
</html>
