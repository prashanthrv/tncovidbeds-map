<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Tamilnadu Covid Beds Availability Map">
     <meta name="author" content="Prashanth R">
    <title>TN Covid Beds Map</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    />
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://pagecdn.io/lib/font-awesome/5.10.0-11/css/all.min.css" integrity="sha256-p9TTWD+813MlLaxMXMbTA7wN/ArzGyW/L7c5+KkjOkM=" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.gstatic.com">
	<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap" rel="stylesheet"> 
    <style>
      #map {
        height: 100%;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: 'Roboto', sans-serif;
      }
      #poweredby{
      	position: fixed;
		z-index: 999;
		bottom: 3px;
		right: 50px;
		font-size: 12px;
      }
      .green-icon{
      	height: 17px !important;
      	width: 17px !important;
      	border-radius: 50%;
      	background-color: green;
      }
      .red-icon{
      	height: 17px !important;
      	width: 17px !important;
      	border-radius: 50%;
      	background-color: red;
      }
      .hospitalInfo{
      	z-index: 999;
		position: absolute;
		top: 20px;
		height: auto;
		width: 300px;
		right: 20px;
		margin-bottom: 20px;
		max-height: 90%;
      }
      .bedsInfo{
      	width:100%;
      }
      .bedsInfo tr{
      	margin-bottom: 15px;
      }
      .title{
      	position: absolute;
		z-index: 999;
		left: 10px;
		bottom: 10px;
      }
      .filterIcon{
      	position: absolute;
    	z-index: 99999;
    	top: 80px;
    	left: 10px;
    	height: 30px;
    	width: 30px;
    	cursor: pointer;
      }
      .filterIcon img{
      	height: 16px;
		margin-top: 8px;
		margin-left: 7px;
      }
      .filterBy{
      	    position: absolute;
		    z-index: 99999;
		    top: 80px;
		    left: 50px;
		    height: auto;
		    width: 250px;
      }
      .toggle-checkbox:checked {
		  @apply: right-0 border-green-400;
		  right: 0;
		  border-color: #68D391;
		}
		.toggle-checkbox:checked + .toggle-label {
		  @apply: bg-green-400;
		  background-color: #68D391;
		}
    </style>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
	<script type="text/javascript" type="module">
    	window.filterData = {
    		oxygen_supported: true,
    		non_oxygen_supported: false,
    		icu_beds: false,
    		show_only_vacant: true
    	}
    	window.hospitalData = []
    </script>
  </head>

  <body>
  	<div class="title shadow-md rounded bg-white p-2">TN Covid Beds Availability <a class="underline text-blue-500" href="/tableview/index.html">Table View</a></div>
    <div id="map"></div>
    <div style="display: none;" class="hospitalInfo">
    	<div class="shadow-md rounded bg-red-500 text-white p-1" style="float: right; width:30px; height: 30px; text-align:center; cursor:pointer" onclick="closeHospital()">
    		<span >X</span>
    	</div>
    	<div class="shadow-md rounded bg-blue-500 text-white p-4 mt-8">
    		<div id="institution" class="text-xl"></div>
	    	<div id="address" class="mt-1"></div>
	    	<div id="landline" class="mt-1">
	    		<a href="" class="underline"></a>
	    	</div>
	    	<div id="contact" class="mt-1">
	    		<a href="" class="underline"></a>
	    	</div>
    	</div>
    	<div class="shadow-md rounded bg-white p-4 mt-2">
    		<table class="bedsInfo">
    			<tbody>
    				<tr>
	    				<td style="width:90%">
	    					Oxygen Supported Beds
	    				</td>
	    				<td id="oxygen_supported" class="font-bold"></td>
	    			</tr>
	    			<tr>
	    				<td style="width:90%">
	    					Normal Beds(wihtout oxygen support)
	    				</td>
	    				<td id="non_oxygen_supported" class="font-bold"></td>
	    			</tr>
	    			<tr>
	    				<td style="width:90%">
	    					ICU Beds
	    				</td>
	    				<td id="icu_beds" class="font-bold"></td>
	    			</tr>
    			</tbody>
    		</table>
    	</div>
    	<div class="shadow-md rounded bg-white p-4 mt-2">
    		<div class="font-bold">Last Updated</div>
    		<div id="lastUpdated"></div>
    	</div>
    </div>
    <div class="filterIcon shadow-md rounded bg-white" onclick="openFilter()">
    	<img src="/images/filter.png" />
    </div>
    <div class="filterBy shadow-md bg-white p-4 rounded" style="display: none;">
    	<div class="mb-2">Filter By</div>

    	<div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
		    <input type="checkbox" checked name="oxygen_supported" id="oxygen_supported_check" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
		    <label for="toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
		</div>
		<label for="toggle" class="text-xs text-gray-700 mb-4">Show Oxygen Supported Beds</label><br/>

		<div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
		    <input type="checkbox" name="non_oxygen_supported" id="non_oxygen_supported_check" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
		    <label for="toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
		</div>
		<label for="toggle" class="text-xs text-gray-700 mb-4">Show Normal Beds</label><br/>

		<div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
		    <input type="checkbox" name="icu_beds" id="icu_beds_check" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
		    <label for="toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
		</div>
		<label for="toggle" class="text-xs text-gray-700 mb-4">Show ICU Beds</label><br/>

		<div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
		    <input type="checkbox" checked name="show_only_vacant" id="show_only_vacant_check" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
		    <label for="toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
		</div>
		<label for="toggle" class="text-xs text-gray-700 mb-4">Show only vacant beds</label><br/>

    	<button class="bg-blue-500 p-1 text-white rounded shadow-md mt-2" onclick="callFilter()">Apply</button>
    	<button class="bg-red-500 p-1 text-white rounded shadow-md mt-2 ml-2" onclick="closeFilter()">Close</button>
    </div>
    <div id="poweredby" class="underline text-blue-500">Data sourced from <a target="_blank" href="https://tncovidbeds.tnega.org/">TNEGA</a></div>
    <div class="w-full h-full fixed block top-0 left-0 bg-white opacity-75 z-50 loadingScreen" style="z-index: 999999">
      <span class="text-green-500 opacity-75 top-1/2 my-0 mx-auto block relative w-0 h-0" style="top: 50%;">
        <i class="fas fa-circle-notch fa-spin fa-5x"></i>
      </span>
    </div>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
	     https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-analytics.js"></script>
    
    <script src="https://unpkg.com/realm-web@1.2.0/dist/bundle.iife.js"></script>

    <script>
      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      var firebaseConfig = {
        apiKey: "AIzaSyCBkBtVWrWisISnECdMP1LTID5E4xbkTOY",
        authDomain: "covid-resource-314307.firebaseapp.com",
        projectId: "covid-resource-314307",
        storageBucket: "covid-resource-314307.appspot.com",
        messagingSenderId: "1018984797",
        appId: "1:1018984797:web:7ea9197dd31169419bd0b4",
        measurementId: "G-DH7YEELKK5"
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      firebase.analytics();
    </script>
    <script type="text/javascript" type="module">
      window.closeHospital = function(){
      	$('.hospitalInfo').hide();
      }
      window.openFilter = function(){
		$('.filterBy').show();
	  }
	  window.closeFilter = function(){
		$('.filterBy').hide();
	  }
	  window.callFilter = function(){
  		window.filterData.oxygen_supported = $('#oxygen_supported_check').prop('checked')
  		window.filterData.non_oxygen_supported = $('#non_oxygen_supported_check').prop('checked')
  		window.filterData.icu_beds = $('#icu_beds_check').prop('checked')
  		window.filterData.show_only_vacant = $('#show_only_vacant_check').prop('checked')
  		window.showHospitalData();
  		window.closeFilter();
	  }
      window.map = L.map("map", {
        center: [11.388, 80.75],
        zoom: 7
      });
      window.layerGrp = L.layerGroup().addTo(window.map);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(
        window.map
      );

      const openHospitalPage = function(hospitalData){
      	$('.hospitalInfo').show();
      	$('#institution').text(hospitalData.Name)
      	const taluk = hospitalData.Taluk!==undefined?hospitalData.Taluk.Name:''
      	const district = hospitalData.District!==undefined?hospitalData.District.Name:''
      	$('#address').text(hospitalData.AddressDetail.Line1+','+taluk+','+district)
      	$('#contact a').text(hospitalData.MobileNumber)
      	$('#contact a').attr('href','tel:'+hospitalData.MobileNumber)
      	$('#landline a').text(hospitalData.Landline)
      	$('#landline a').attr('href','tel:'+hospitalData.Landline)

      	$('#oxygen_supported').text(hospitalData.CovidBedDetails.VaccantO2Beds+"/"+hospitalData.CovidBedDetails.AllotedO2Beds)
      	$('#non_oxygen_supported').text(hospitalData.CovidBedDetails.VaccantNonO2Beds+"/"+hospitalData.CovidBedDetails.AllotedNonO2Beds)
      	$('#icu_beds').text(hospitalData.CovidBedDetails.VaccantICUBeds+"/"+hospitalData.CovidBedDetails.AllotedICUBeds)

      	$('#lastUpdated').text(new Date(hospitalData.UpdatedDateTime*1000))
      	$('#remarks').text(hospitalData.remarks)	
      }

      const params = {"searchString":"","sortCondition":{"Name":1},"pageNumber":1,"pageLimit":2000,"SortValue":"Availability","ShowIfVacantOnly":"","IsGovernmentHospital":true,"IsPrivateHospital":true,"FacilityTypes":["CHO","CHC","CCC"]};

      window.showHospitalData = function(){
        $('.loadingScreen').hide();
      	window.layerGrp.clearLayers();
  			window.hospitalData.forEach((hospital)=>{
  				if(hospital.Latitude!==undefined && hospital.Latitude!==null && hospital.Longitude!==undefined && hospital.Longitude!==null){
  					
  					const greenIcon = L.divIcon({className: 'green-icon'});
  	      			const redIcon = L.divIcon({className: 'red-icon'});
  	      			let myIcon = null;

  					if(window.filterData.show_only_vacant){
  						if((window.filterData.oxygen_supported && parseInt(hospital.CovidBedDetails.VaccantO2Beds)>0) || (window.filterData.non_oxygen_supported && parseInt(hospital.CovidBedDetails.VaccantNonO2Beds)>0) || (window.filterData.icu_beds && parseInt(hospital.CovidBedDetails.VaccantICUBeds)>0)){
  			 		       	myIcon = greenIcon
  			 		       	if((window.filterData.oxygen_supported && parseInt(hospital.CovidBedDetails.AllotedO2Beds)>0) || (window.filterData.non_oxygen_supported && parseInt(hospital.CovidBedDetails.AllotedNonO2Beds)>0) || (window.filterData.icu_beds && parseInt(hospital.CovidBedDetails.AllotedICUBeds)>0)){
                      const hospitalMarker = L.marker([hospital.Latitude, hospital.Longitude], { icon: myIcon}).addTo(window.layerGrp)
                      hospitalMarker.on('click', function(data){
                        openHospitalPage(hospital)
                      })
                    }
  			        	}
  					}
  					else{
  						if((window.filterData.oxygen_supported && parseInt(hospital.CovidBedDetails.VaccantO2Beds)>0) || (window.filterData.non_oxygen_supported && parseInt(hospital.CovidBedDetails.VaccantNonO2Beds)>0) || (window.filterData.icu_beds && parseInt(hospital.CovidBedDetails.VaccantICUBeds)>0)){
  			 		       	myIcon = greenIcon
  			        	}else{
  			        		myIcon = redIcon
  			        	}
                  if((window.filterData.oxygen_supported && parseInt(hospital.CovidBedDetails.AllotedO2Beds)>0) || (window.filterData.non_oxygen_supported && parseInt(hospital.CovidBedDetails.AllotedNonO2Beds)>0) || (window.filterData.icu_beds && parseInt(hospital.CovidBedDetails.AllotedICUBeds)>0)){
                    const hospitalMarker = L.marker([hospital.Latitude, hospital.Longitude], { icon: myIcon}).addTo(window.layerGrp)
                    hospitalMarker.on('click', function(data){
                      openHospitalPage(hospital)
                    })
                  }
  					}
  	      			
        			}
  			})      	
      }

      const app = new Realm.App({ id: "tncovidresource-wvjzp" });
      const credentials = Realm.Credentials.apiKey("An0lsNjTyVQtGNOJ1mD9EdKWYKeeTbMIM8H8R1dG2AKMzx1b9fSgG72iv67C7pFF");
	    app.logIn(credentials).then(function(user){
	    	const mongodb = app.currentUser.mongoClient("mongodb-atlas");
	    	const hospitalCollection = mongodb.db("covidresource").collection("tn_hospital_locations");
	    	hospitalCollection.find().then(function(hospitalList){
	    		window.hospitalData = hospitalList
	    		window.showHospitalData();
	    	})
	    })
    </script>
  </body>
</html>
